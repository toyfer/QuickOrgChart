# QuickOrgChart 仕様書

## 概要

CSVファイルから組織階層（部・課・係など可変）と職員情報を読み取り、クライアントサイドのみでモダンなツリー形式の組織図を生成するWebアプリケーションです。組織階層・役職階層ともに柔軟に対応し、組織コード・役職コードによるソート、統計情報表示、折りたたみ機能、検索機能、HTMLエクスポート機能を提供します。

---

## CSVフォーマット仕様

- **組織階層は可変長**
    - 「職員番号」列または「氏名」列までの間に、組織コード・組織名のペアが繰り返される
    - 例: 部コード, 部名, 課コード, 課名, 係コード, 係名, ...
- **必須列**
    - 組織コードN, 組織名N ...（職員番号まで繰り返し）
    - 氏名, 職員番号, 役職コード, 役職
- **列数・階層数に制限なし**
- **各コード桁数規則**
    - 組織コード: 任意（例: A01, B01, C01）
    - 役職コード: 任意（例: 100, 200, 300）
    - 職員番号: 任意（例: 10001, 10002）
- **現在のサンプルヘッダー**

```
部コード,部名,課コード,課名,係コード,係名,氏名,職員番号,役職コード,役職
```

---

## 主な機能・要件

### 1. 組織階層の自動検出
- 「職員番号」列までの間の偶数列を組織コード、奇数列を組織名として自動的に階層化
- 職員番号列が見つかった時点で組織階層の構築を終了
- 階層数は可変（部・課・係以外の階層も対応）

### 2. ソート機能
- **組織**: 組織コード順（昇順、左から右の列順）
- **職員**: 役職コード昇順 → 職員番号昇順（小さい数値ほど上位）
- 文字列・数値の柔軟な比較処理

### 3. 表示機能
- 組織名の横に組織コード表示：例「総務課 [001]」
- 職員情報：「氏名（役職/職員番号）」形式
- 統計情報表示：直属人数、総人数、役職別人数
- 階層レベル別の色分け表示

### 4. インタラクティブ機能
- 各組織セクションの折りたたみ/展開
- ドラッグ&ドロップによるCSVファイル読み込み
- リーダーハイライト閾値の動的設定
- リアルタイム表示更新
- **検索機能**
  - インクリメンタル検索（1文字入力ごとに結果更新）
  - 組織名・職員名・職員番号・役職での検索
  - キーボードナビゲーション（矢印キー、Enter、Escape）
  - 検索結果への自動スクロール・ハイライト

### 5. エクスポート機能
- 現在の表示状態をHTMLファイルとしてダウンロード
- スタンドアロンで動作するHTML（CSS・JavaScript・検索機能含む）
- 印刷対応レイアウト
- エクスポートされたHTMLでも検索機能が完全動作

### 6. セキュリティ対応
- XSS対策（HTMLエスケープ処理）
- クライアントサイドのみで動作（サーバー不要）

---

## UI/UX仕様

### デザインテーマ
- モダンなフラット背景（#fafafa）
- Noto Sans JP フォント使用
- Font Awesome アイコン統合
- レスポンシブデザイン対応
- ブルー系カラーパレット

### メイン画面構成
1. **ヘッダーセクション**
   - タイトル「組織図一覧」
   - サブタイトル「CSVファイルから組織構造を可視化」

2. **アップロードセクション**
   - ドラッグ&ドロップエリア
   - ファイル選択ボタン
   - 視覚的フィードバック（ホバー、ドロップ効果）

3. **検索セクション**（CSVロード後に表示）
   - 検索入力フィールド
   - インクリメンタル検索結果表示
   - キーボードナビゲーション対応

4. **設定パネル**（CSVロード後に表示）
   - リーダーハイライト閾値設定
   - 設定適用ボタン
   - HTMLダウンロードボタン

5. **組織図表示エリア**
   - ツリー構造での階層表示
   - 折りたたみ可能なセクション
   - 統計情報表示
   - 階層レベル別色分け

### スタイル詳細
- 組織ノード：フラット背景、モダンなボーダー装飾
- メンバー表示：グリッドレイアウト、カード形式
- リーダーハイライト：オレンジ系強調表示
- アニメーション：ホバー効果、折りたたみ遷移
- 検索結果：ハイライト効果、スムーズスクロール

---

## 技術仕様

### フロントエンド技術
- **HTML5**: セマンティックマークアップ
- **CSS3**: Flexbox、Grid、カスタムプロパティ使用
- **JavaScript (ES6+)**: モジュール化設計、TypeScript互換コメント
- **外部ライブラリ**: Font Awesome 6.0、Google Fonts

### データ処理フロー
1. **CSVパース**: カンマ区切り解析、ヘッダー自動検出
2. **組織階層構築**: 動的レベル検出、ツリー構造生成
3. **統計計算**: 直属・総計人数、役職別集計
4. **検索インデックス構築**: 高速検索のためのインデックス生成
5. **HTML生成**: エスケープ処理、レスポンシブ対応
6. **インタラクション**: 折りたたみ、設定適用、検索、エクスポート

### 性能要件
- クライアントサイド完結（サーバー不要）
- 大規模組織対応（1000名以上）
- リアルタイム更新（設定変更時）
- ブラウザ互換性（モダンブラウザ対応）

---

## サンプルCSV（最新版）

```
部コード,部名,課コード,課名,係コード,係名,氏名,職員番号,役職コード,役職
A01,総務部,B01,人事課,,,山田太郎,10001,100,課長
A01,総務部,B01,人事課,C01,給与係,佐藤花子,10002,200,主任
A01,総務部,B01,人事課,C01,給与係,鈴木一郎,10003,300,一般
A01,総務部,B01,人事課,C02,採用係,田中健,10004,100,係長
A01,総務部,B01,人事課,C02,採用係,高橋美咲,10005,200,主任
A01,総務部,B01,人事課,C02,採用係,伊藤誠,10006,300,一般
A02,企画部,B03,企画課,,,清水彩,10013,100,課長
A02,企画部,B03,企画課,C05,政策係,山口大輔,10014,200,主任
A02,企画部,B03,企画課,C05,政策係,森田真,10015,300,一般
A03,財務部,B05,会計課,,,西村誠,10025,100,課長
```

---

## 実装のポイント

### 組織階層検出アルゴリズム
- 「職員番号」列を基準点として組織階層を判定
- 組織コード・組織名のペアパターンを自動検出
- 空白セルは階層終了として処理

### ツリー構造の構築
- 各組織ノードにメタデータ（レベル、統計情報）を付与
- メンバーは最も具体的な所属組織に配置
- 子組織含む総人数の再帰計算

### 表示レンダリング
1. 組織ヘッダー（名前、コード、統計）
2. 直属メンバー（役職コード昇順 → 職員番号昇順）
3. 子組織（組織コード昇順）
4. 折りたたみ制御用DOM ID生成
5. 検索結果のハイライト表示

### エラーハンドリング
- 必須列の存在チェック
- CSVフォーマット検証
- 数値変換エラー対応
- ファイル読み込みエラー処理

---

## 運用・保守

### ファイル構成
```
orgchartor/
├── index.html          # メインHTML
├── main.js            # JavaScript実装
├── style.css          # スタイルシート
├── sample.csv         # サンプルデータ
├── specification.md   # 本ドキュメント
├── README.md          # プロジェクト概要
├── OFFLINE_SETUP.md   # オフライン設定ガイド
├── setup-offline.ps1  # フォント設定スクリプト
└── assets/
    ├── css/
    │   ├── noto-sans-jp.css      # フォントCSS
    │   └── fontawesome.min.css   # アイコンCSS
    └── fonts/
        ├── NotoSansJP-*.woff     # 日本語フォント
        └── fa-*-400.woff2        # Font Awesomeアイコン
```

### カスタマイズポイント
- CSS変数による色テーマ変更
- 統計表示項目の追加
- エクスポート形式の拡張
- 追加の組織階層レベル対応

### トラブルシューティング
- CSV形式エラー：必須列の確認
- 表示崩れ：ブラウザキャッシュクリア
- パフォーマンス：大規模データでの分割読み込み検討

---

## 更新履歴

- **v1.0** (2024): 基本機能実装
- **v2.0** (2025): モダンUI導入、統計機能追加
- **v2.1** (2025): 折りたたみ機能、HTMLエクスポート
- **v2.2** (2025): 動的設定、ドラッグ&ドロップ対応
- **v2.3** (2025): 検索機能実装、インクリメンタル検索、キーボードナビゲーション
- **v2.4** (2025): 検索機能実装、インクリメンタル検索、キーボードナビゲーション、エクスポートHTML内検索機能、オフライン対応強化

---

## 参考：表示イメージ

```
🔍 検索: "山田" → 結果: 山田太郎（課長/総務部 > 人事課）

📁 総務部 [A01] (直属:0人 総計:6人 - 課長:1人, 主任:2人, 一般:2人, 係長:1人)
├── 📁 人事課 [B01] (直属:1人 総計:6人 - 課長:1人)
│   ├── 👤 山田太郎（課長/10001） ← 検索結果ハイライト
│   ├── 📁 給与係 [C01] (2人 - 主任:1人, 一般:1人)
│   │   ├── 👤 佐藤花子（主任/10002）
│   │   └── 👤 鈴木一郎（一般/10003）
│   └── 📁 採用係 [C02] (3人 - 係長:1人, 主任:1人, 一般:1人)
│       ├── 👤 田中健（係長/10004）
│       ├── 👤 高橋美咲（主任/10005）
│       └── 👤 伊藤誠（一般/10006）
└── （その他の組織）
```
